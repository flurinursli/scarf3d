#ifdef DOUBLE_PREC

RECURSIVE SUBROUTINE QNG ( F, A, B, EPSABS, EPSREL, RESULT, ABSERR, NEVAL, IER )

!*****************************************************************************80
!
!! DQNG ESTIMATES AN INTEGRAL, USING NON-ADAPTIVE INTEGRATION.
!
!  MODIFIED:
!
!    11 SEPTEMBER 2015
!
!  AUTHOR:
!
!    ROBERT PIESSENS, ELISE DE DONCKER
!
!***PURPOSE  THE ROUTINE CALCULATES AN APPROXIMATION RESULT TO A
!      GIVEN DEFINITE INTEGRAL I = INTEGRAL OF F OVER (A,B),
!      HOPEFULLY SATISFYING FOLLOWING CLAIM FOR ACCURACY
!      ABS(I-RESULT).LE.MAX(EPSABS,EPSREL*ABS(I)).
!
!  PARAMETERS:
!
!     F      - REAL ( KIND = 8 )
!              FUNCTION SUBPROGRAM DEFINING THE INTEGRAND FUNCTION
!              F(X). THE ACTUAL NAME FOR F NEEDS TO BE DECLARED
!              E X T E R N A L IN THE DRIVER PROGRAM.
!
!     A      - REAL ( KIND = 8 )
!              LOWER LIMIT OF INTEGRATION
!
!     B      - REAL ( KIND = 8 )
!              UPPER LIMIT OF INTEGRATION
!
!     EPSABS - REAL ( KIND = 8 )
!              ABSOLUTE ACCURACY REQUESTED
!     EPSREL - REAL ( KIND = 8 )
!              RELATIVE ACCURACY REQUESTED
!              IF  EPSABS.LE.0
!              AND EPSREL.LT.MAX(50*REL.MACH.ACC.,0.5D-28),
!              THE ROUTINE WILL END WITH IER = 6.
!
!   ON RETURN
!     RESULT - REAL ( KIND = 8 )
!              APPROXIMATION TO THE INTEGRAL I
!              RESULT IS OBTAINED BY APPLYING THE 21-POINT
!              GAUSS-KRONROD RULE (RES21) OBTAINED BY OPTIMAL
!              ADDITION OF ABSCISSAE TO THE 10-POINT GAUSS RULE
!              (RES10), OR BY APPLYING THE 43-POINT RULE (RES43)
!              OBTAINED BY OPTIMAL ADDITION OF ABSCISSAE TO THE
!              21-POINT GAUSS-KRONROD RULE, OR BY APPLYING THE
!              87-POINT RULE (RES87) OBTAINED BY OPTIMAL ADDITION
!              OF ABSCISSAE TO THE 43-POINT RULE.
!
!     ABSERR - REAL ( KIND = 8 )
!              ESTIMATE OF THE MODULUS OF THE ABSOLUTE ERROR,
!              WHICH SHOULD EQUAL OR EXCEED ABS(I-RESULT)
!
!     NEVAL  - INTEGER ( KIND = 4 )
!              NUMBER OF INTEGRAND EVALUATIONS
!
!     IER    - IER = 0 NORMAL AND RELIABLE TERMINATION OF THE
!                      ROUTINE. IT IS ASSUMED THAT THE REQUESTED
!                      ACCURACY HAS BEEN ACHIEVED.
!              IER.GT.0 ABNORMAL TERMINATION OF THE ROUTINE. IT IS
!                      ASSUMED THAT THE REQUESTED ACCURACY HAS
!                      NOT BEEN ACHIEVED.
!     ERROR MESSAGES
!              IER = 1 THE MAXIMUM NUMBER OF STEPS HAS BEEN
!                      EXECUTED. THE INTEGRAL IS PROBABLY TOO
!                      DIFFICULT TO BE CALCULATED BY DQNG.
!                  = 6 THE INPUT IS INVALID, BECAUSE
!                      EPSABS.LE.0 AND
!                      EPSREL.LT.MAX(50*REL.MACH.ACC.,0.5D-28).
!                      RESULT, ABSERR AND NEVAL ARE SET TO ZERO.
!
!  LOCAL PARAMETERS:
!
!     THE DATA STATEMENTS CONTAIN THE
!     ABSCISSAE AND WEIGHTS OF THE INTEGRATION RULES USED.
!
!     X1      ABSCISSAE COMMON TO THE 10-, 21-, 43- AND 87-
!             POINT RULE
!     X2      ABSCISSAE COMMON TO THE 21-, 43- AND 87-POINT RULE
!     X3      ABSCISSAE COMMON TO THE 43- AND 87-POINT RULE
!     X4      ABSCISSAE OF THE 87-POINT RULE
!     W10     WEIGHTS OF THE 10-POINT FORMULA
!     W21A    WEIGHTS OF THE 21-POINT FORMULA FOR ABSCISSAE X1
!     W21B    WEIGHTS OF THE 21-POINT FORMULA FOR ABSCISSAE X2
!     W43A    WEIGHTS OF THE 43-POINT FORMULA FOR ABSCISSAE X1, X3
!     W43B    WEIGHTS OF THE 43-POINT FORMULA FOR ABSCISSAE X3
!     W87A    WEIGHTS OF THE 87-POINT FORMULA FOR ABSCISSAE X1,
!             X2, X3
!     W87B    WEIGHTS OF THE 87-POINT FORMULA FOR ABSCISSAE X4
!
!
! GAUSS-KRONROD-PATTERSON QUADRATURE COEFFICIENTS FOR USE IN
! QUADPACK ROUTINE QNG.  THESE COEFFICIENTS WERE CALCULATED WITH
! 101 DECIMAL DIGIT ARITHMETIC BY L. W. FULLERTON, BELL LABS, NOV 1981.
!
!     CENTR  - MID POINT OF THE INTEGRATION INTERVAL
!     HLGTH  - HALF-LENGTH OF THE INTEGRATION INTERVAL
!     FCENTR - FUNCTION VALUE AT MID POINT
!     ABSC   - ABSCISSA
!     FVAL   - FUNCTION VALUE
!     SAVFUN - ARRAY OF FUNCTION VALUES WHICH HAVE ALREADY BEEN
!              COMPUTED
!     RES10  - 10-POINT GAUSS RESULT
!     RES21  - 21-POINT KRONROD RESULT
!     RES43  - 43-POINT RESULT
!     RES87  - 87-POINT RESULT
!     RESABS - APPROXIMATION TO THE INTEGRAL OF ABS(F)
!     RESASC - APPROXIMATION TO THE INTEGRAL OF ABS(F-I/(B-A))
!
!     MACHINE DEPENDENT CONSTANTS
!
!     EPMACH IS THE LARGEST RELATIVE SPACING.
!     UFLOW IS THE SMALLEST POSITIVE MAGNITUDE.
!
  IMPLICIT NONE

  REAL ( KIND = 8 ) A,ABSC,ABSERR,B,CENTR,DHLGTH, &
    EPMACH,EPSABS,EPSREL,F,FCENTR,FVAL,FVAL1,FVAL2,FV1,FV2, &
    FV3,FV4,HLGTH,RESULT,RES10,RES21,RES43,RES87,RESABS,RESASC, &
    RESKH,SAVFUN,UFLOW,W10,W21A,W21B,W43A,W43B,W87A,W87B,X1,X2,X3,X4
  INTEGER ( KIND = 4 ) IER,IPX,K,L,NEVAL
  EXTERNAL F
  DIMENSION FV1(5),FV2(5),FV3(5),FV4(5),X1(5),X2(5),X3(11),X4(22), &
    W10(5),W21A(5),W21B(6),W43A(10),W43B(12),W87A(21),W87B(23), &
    SAVFUN(21)

  DATA X1    (  1) / 0.973906528517171720077964012084452D0 /
  DATA X1    (  2) / 0.865063366688984510732096688423493D0 /
  DATA X1    (  3) / 0.679409568299024406234327365114874D0 /
  DATA X1    (  4) / 0.433395394129247190799265943165784D0 /
  DATA X1    (  5) / 0.148874338981631210884826001129720D0 /
  DATA W10   (  1) / 0.066671344308688137593568809893332D0 /
  DATA W10   (  2) / 0.149451349150580593145776339657697D0 /
  DATA W10   (  3) / 0.219086362515982043995534934228163D0 /
  DATA W10   (  4) / 0.269266719309996355091226921569469D0 /
  DATA W10   (  5) / 0.295524224714752870173892994651338D0 /

  DATA X2    (  1) / 0.995657163025808080735527280689003D0 /
  DATA X2    (  2) / 0.930157491355708226001207180059508D0 /
  DATA X2    (  3) / 0.780817726586416897063717578345042D0 /
  DATA X2    (  4) / 0.562757134668604683339000099272694D0 /
  DATA X2    (  5) / 0.294392862701460198131126603103866D0 /
  DATA W21A  (  1) / 0.032558162307964727478818972459390D0 /
  DATA W21A  (  2) / 0.075039674810919952767043140916190D0 /
  DATA W21A  (  3) / 0.109387158802297641899210590325805D0 /
  DATA W21A  (  4) / 0.134709217311473325928054001771707D0 /
  DATA W21A  (  5) / 0.147739104901338491374841515972068D0 /
  DATA W21B  (  1) / 0.011694638867371874278064396062192D0 /
  DATA W21B  (  2) / 0.054755896574351996031381300244580D0 /
  DATA W21B  (  3) / 0.093125454583697605535065465083366D0 /
  DATA W21B  (  4) / 0.123491976262065851077958109831074D0 /
  DATA W21B  (  5) / 0.142775938577060080797094273138717D0 /
  DATA W21B  (  6) / 0.149445554002916905664936468389821D0 /
!
  DATA X3    (  1) / 0.999333360901932081394099323919911D0 /
  DATA X3    (  2) / 0.987433402908088869795961478381209D0 /
  DATA X3    (  3) / 0.954807934814266299257919200290473D0 /
  DATA X3    (  4) / 0.900148695748328293625099494069092D0 /
  DATA X3    (  5) / 0.825198314983114150847066732588520D0 /
  DATA X3    (  6) / 0.732148388989304982612354848755461D0 /
  DATA X3    (  7) / 0.622847970537725238641159120344323D0 /
  DATA X3    (  8) / 0.499479574071056499952214885499755D0 /
  DATA X3    (  9) / 0.364901661346580768043989548502644D0 /
  DATA X3    ( 10) / 0.222254919776601296498260928066212D0 /
  DATA X3    ( 11) / 0.074650617461383322043914435796506D0 /
  DATA W43A  (  1) / 0.016296734289666564924281974617663D0 /
  DATA W43A  (  2) / 0.037522876120869501461613795898115D0 /
  DATA W43A  (  3) / 0.054694902058255442147212685465005D0 /
  DATA W43A  (  4) / 0.067355414609478086075553166302174D0 /
  DATA W43A  (  5) / 0.073870199632393953432140695251367D0 /
  DATA W43A  (  6) / 0.005768556059769796184184327908655D0 /
  DATA W43A  (  7) / 0.027371890593248842081276069289151D0 /
  DATA W43A  (  8) / 0.046560826910428830743339154433824D0 /
  DATA W43A  (  9) / 0.061744995201442564496240336030883D0 /
  DATA W43A  ( 10) / 0.071387267268693397768559114425516D0 /
  DATA W43B  (  1) / 0.001844477640212414100389106552965D0 /
  DATA W43B  (  2) / 0.010798689585891651740465406741293D0 /
  DATA W43B  (  3) / 0.021895363867795428102523123075149D0 /
  DATA W43B  (  4) / 0.032597463975345689443882222526137D0 /
  DATA W43B  (  5) / 0.042163137935191811847627924327955D0 /
  DATA W43B  (  6) / 0.050741939600184577780189020092084D0 /
  DATA W43B  (  7) / 0.058379395542619248375475369330206D0 /
  DATA W43B  (  8) / 0.064746404951445885544689259517511D0 /
  DATA W43B  (  9) / 0.069566197912356484528633315038405D0 /
  DATA W43B  ( 10) / 0.072824441471833208150939535192842D0 /
  DATA W43B  ( 11) / 0.074507751014175118273571813842889D0 /
  DATA W43B  ( 12) / 0.074722147517403005594425168280423D0 /

  DATA X4    (  1) / 0.999902977262729234490529830591582D0 /
  DATA X4    (  2) / 0.997989895986678745427496322365960D0 /
  DATA X4    (  3) / 0.992175497860687222808523352251425D0 /
  DATA X4    (  4) / 0.981358163572712773571916941623894D0 /
  DATA X4    (  5) / 0.965057623858384619128284110607926D0 /
  DATA X4    (  6) / 0.943167613133670596816416634507426D0 /
  DATA X4    (  7) / 0.915806414685507209591826430720050D0 /
  DATA X4    (  8) / 0.883221657771316501372117548744163D0 /
  DATA X4    (  9) / 0.845710748462415666605902011504855D0 /
  DATA X4    ( 10) / 0.803557658035230982788739474980964D0 /
  DATA X4    ( 11) / 0.757005730685495558328942793432020D0 /
  DATA X4    ( 12) / 0.706273209787321819824094274740840D0 /
  DATA X4    ( 13) / 0.651589466501177922534422205016736D0 /
  DATA X4    ( 14) / 0.593223374057961088875273770349144D0 /
  DATA X4    ( 15) / 0.531493605970831932285268948562671D0 /
  DATA X4    ( 16) / 0.466763623042022844871966781659270D0 /
  DATA X4    ( 17) / 0.399424847859218804732101665817923D0 /
  DATA X4    ( 18) / 0.329874877106188288265053371824597D0 /
  DATA X4    ( 19) / 0.258503559202161551802280975429025D0 /
  DATA X4    ( 20) / 0.185695396568346652015917141167606D0 /
  DATA X4    ( 21) / 0.111842213179907468172398359241362D0 /
  DATA X4    ( 22) / 0.037352123394619870814998165437704D0 /
  DATA W87A  (  1) / 0.008148377384149172900002878448190D0 /
  DATA W87A  (  2) / 0.018761438201562822243935059003794D0 /
  DATA W87A  (  3) / 0.027347451050052286161582829741283D0 /
  DATA W87A  (  4) / 0.033677707311637930046581056957588D0 /
  DATA W87A  (  5) / 0.036935099820427907614589586742499D0 /
  DATA W87A  (  6) / 0.002884872430211530501334156248695D0 /
  DATA W87A  (  7) / 0.013685946022712701888950035273128D0 /
  DATA W87A  (  8) / 0.023280413502888311123409291030404D0 /
  DATA W87A  (  9) / 0.030872497611713358675466394126442D0 /
  DATA W87A  ( 10) / 0.035693633639418770719351355457044D0 /
  DATA W87A  ( 11) / 0.000915283345202241360843392549948D0 /
  DATA W87A  ( 12) / 0.005399280219300471367738743391053D0 /
  DATA W87A  ( 13) / 0.010947679601118931134327826856808D0 /
  DATA W87A  ( 14) / 0.016298731696787335262665703223280D0 /
  DATA W87A  ( 15) / 0.021081568889203835112433060188190D0 /
  DATA W87A  ( 16) / 0.025370969769253827243467999831710D0 /
  DATA W87A  ( 17) / 0.029189697756475752501446154084920D0 /
  DATA W87A  ( 18) / 0.032373202467202789685788194889595D0 /
  DATA W87A  ( 19) / 0.034783098950365142750781997949596D0 /
  DATA W87A  ( 20) / 0.036412220731351787562801163687577D0 /
  DATA W87A  ( 21) / 0.037253875503047708539592001191226D0 /
  DATA W87B  (  1) / 0.000274145563762072350016527092881D0 /
  DATA W87B  (  2) / 0.001807124155057942948341311753254D0 /
  DATA W87B  (  3) / 0.004096869282759164864458070683480D0 /
  DATA W87B  (  4) / 0.006758290051847378699816577897424D0 /
  DATA W87B  (  5) / 0.009549957672201646536053581325377D0 /
  DATA W87B  (  6) / 0.012329447652244853694626639963780D0 /
  DATA W87B  (  7) / 0.015010447346388952376697286041943D0 /
  DATA W87B  (  8) / 0.017548967986243191099665352925900D0 /
  DATA W87B  (  9) / 0.019938037786440888202278192730714D0 /
  DATA W87B  ( 10) / 0.022194935961012286796332102959499D0 /
  DATA W87B  ( 11) / 0.024339147126000805470360647041454D0 /
  DATA W87B  ( 12) / 0.026374505414839207241503786552615D0 /
  DATA W87B  ( 13) / 0.028286910788771200659968002987960D0 /
  DATA W87B  ( 14) / 0.030052581128092695322521110347341D0 /
  DATA W87B  ( 15) / 0.031646751371439929404586051078883D0 /
  DATA W87B  ( 16) / 0.033050413419978503290785944862689D0 /
  DATA W87B  ( 17) / 0.034255099704226061787082821046821D0 /
  DATA W87B  ( 18) / 0.035262412660156681033782717998428D0 /
  DATA W87B  ( 19) / 0.036076989622888701185500318003895D0 /
  DATA W87B  ( 20) / 0.036698604498456094498018047441094D0 /
  DATA W87B  ( 21) / 0.037120549269832576114119958413599D0 /
  DATA W87B  ( 22) / 0.037334228751935040321235449094698D0 /
  DATA W87B  ( 23) / 0.037361073762679023410321241766599D0 /

  EPMACH = EPSILON ( EPMACH )
  UFLOW = TINY ( UFLOW )
!
!  TEST ON VALIDITY OF PARAMETERS
!
  RESULT = 0.0D+00
  ABSERR = 0.0D+00
  NEVAL = 0
  IER = 6
  IF(EPSABS.LE.0.0D+00.AND.EPSREL.LT. MAX ( 0.5D+02*EPMACH,0.5D-28)) &
    GO TO 80
  HLGTH = 0.5D+00*(B-A)
  DHLGTH =  ABS ( HLGTH)
  CENTR = 0.5D+00*(B+A)
  FCENTR = F(CENTR)
  NEVAL = 21
  IER = 1
!
!  COMPUTE THE INTEGRAL USING THE 10- AND 21-POINT FORMULA.
!
  DO 70 L = 1,3

    GO TO (5,25,45),L

    5 RES10 = 0.0D+00
    RES21 = W21B(6)*FCENTR
    RESABS = W21B(6)* ABS ( FCENTR)

    DO K=1,5
      ABSC = HLGTH*X1(K)
      FVAL1 = F(CENTR+ABSC)
      FVAL2 = F(CENTR-ABSC)
      FVAL = FVAL1+FVAL2
      RES10 = RES10+W10(K)*FVAL
      RES21 = RES21+W21A(K)*FVAL
      RESABS = RESABS+W21A(K)*( ABS ( FVAL1)+ ABS ( FVAL2))
      SAVFUN(K) = FVAL
      FV1(K) = FVAL1
      FV2(K) = FVAL2
    END DO

    IPX = 5

    DO K=1,5
      IPX = IPX+1
      ABSC = HLGTH*X2(K)
      FVAL1 = F(CENTR+ABSC)
      FVAL2 = F(CENTR-ABSC)
      FVAL = FVAL1+FVAL2
      RES21 = RES21+W21B(K)*FVAL
      RESABS = RESABS+W21B(K)*( ABS ( FVAL1)+ ABS ( FVAL2))
      SAVFUN(IPX) = FVAL
      FV3(K) = FVAL1
      FV4(K) = FVAL2
    END DO
!
!  TEST FOR CONVERGENCE.
!
    RESULT = RES21*HLGTH
    RESABS = RESABS*DHLGTH
    RESKH = 0.5D+00*RES21
    RESASC = W21B(6)* ABS ( FCENTR-RESKH)

    DO K = 1,5
      RESASC = RESASC+W21A(K)*( ABS ( FV1(K)-RESKH)+ ABS ( FV2(K)-RESKH)) &
                      +W21B(K)*( ABS ( FV3(K)-RESKH)+ ABS ( FV4(K)-RESKH))
    END DO

    ABSERR =  ABS ( (RES21-RES10)*HLGTH)
    RESASC = RESASC*DHLGTH
    GO TO 65
!
!  COMPUTE THE INTEGRAL USING THE 43-POINT FORMULA.
!
25  RES43 = W43B(12)*FCENTR
    NEVAL = 43

    DO K=1,10
      RES43 = RES43+SAVFUN(K)*W43A(K)
    END DO

    DO K=1,11
      IPX = IPX+1
      ABSC = HLGTH*X3(K)
      FVAL = F(ABSC+CENTR)+F(CENTR-ABSC)
      RES43 = RES43+FVAL*W43B(K)
      SAVFUN(IPX) = FVAL
    END DO
!
!  TEST FOR CONVERGENCE.
!
    RESULT = RES43*HLGTH
    ABSERR =  ABS ( (RES43-RES21)*HLGTH)
    GO TO 65
!
!  COMPUTE THE INTEGRAL USING THE 87-POINT FORMULA.
!
45  RES87 = W87B(23)*FCENTR
    NEVAL = 87

    DO K=1,21
      RES87 = RES87+SAVFUN(K)*W87A(K)
    END DO

    DO K=1,22
      ABSC = HLGTH*X4(K)
      RES87 = RES87+W87B(K)*(F(ABSC+CENTR)+F(CENTR-ABSC))
    END DO

    RESULT = RES87*HLGTH
    ABSERR =  ABS ( (RES87-RES43)*HLGTH)

65  CONTINUE

    IF(RESASC.NE.0.0D+00.AND.ABSERR.NE.0.0D+00) THEN
      ABSERR = RESASC* MIN (0.1D+01,(0.2D+03*ABSERR/RESASC)**1.5D+00)
    END IF

    IF (RESABS.GT.UFLOW/(0.5D+02*EPMACH)) THEN
      ABSERR = MAX ((EPMACH*0.5D+02)*RESABS,ABSERR)
    END IF

    IF (ABSERR.LE. MAX ( EPSABS,EPSREL* ABS ( RESULT))) THEN
      IER = 0
      RETURN
    END IF

70  CONTINUE

   80 CALL XERROR('ABNORMAL RETURN FROM DQNG ',26,IER,0)
  999 CONTINUE

  RETURN
END

SUBROUTINE XERROR ( XMESS, NMESS, NERR, LEVEL )

!*****************************************************************************80
!
!! XERROR REPLACES THE SLATEC XERROR ROUTINE.
!
!  MODIFIED:
!
!    12 SEPTEMBER 2015
!
  IMPLICIT NONE

  INTEGER ( KIND = 4 ) LEVEL
  INTEGER ( KIND = 4 ) NERR
  INTEGER ( KIND = 4 ) NMESS
  CHARACTER ( LEN = * ) XMESS

  IF ( 1 <= LEVEL ) THEN
    WRITE ( *,'(1X,A)') XMESS(1:NMESS)
    WRITE ( *,'('' ERROR NUMBER = '',I5,'', MESSAGE LEVEL = '',I5)') &
        NERR,LEVEL
  END IF

  RETURN
END

#else

! SUBROUTINE QNG ( F, A, B, EPSABS, EPSREL, RESULT, ABSERR, NEVAL, IER )
!
! !*****************************************************************************80
! !
! !! QNG ESTIMATES AN INTEGRAL, USING NON-ADAPTIVE INTEGRATION.
! !
! !  DISCUSSION:
! !
! !    THE ROUTINE CALCULATES AN APPROXIMATION RESULT TO A DEFINITE INTEGRAL
! !      I = INTEGRAL OF F OVER (A,B),
! !    HOPEFULLY SATISFYING
! !      || I - RESULT || <= MAX ( EPSABS, EPSREL * ||I|| ).
! !
! !    THE ROUTINE IS A SIMPLE NON-ADAPTIVE AUTOMATIC INTEGRATOR, BASED ON
! !    A SEQUENCE OF RULES WITH INCREASING DEGREE OF ALGEBRAIC
! !    PRECISION (PATTERSON, 1968).
! !
! !  AUTHOR:
! !
! !    ROBERT PIESSENS, ELISE DE DONCKER-KAPENGER,
! !    CHRISTIAN UEBERHUBER, DAVID KAHANER
! !
! !  REFERENCE:
! !
! !    ROBERT PIESSENS, ELISE DE DONCKER-KAPENGER,
! !    CHRISTIAN UEBERHUBER, DAVID KAHANER,
! !    QUADPACK, A SUBROUTINE PACKAGE FOR AUTOMATIC INTEGRATION,
! !    SPRINGER VERLAG, 1983
! !
! !  PARAMETERS:
! !
! !    INPUT, EXTERNAL REAL ( KIND = 4 ) F, THE NAME OF THE FUNCTION ROUTINE, OF THE FORM
! !      FUNCTION F ( X )
! !      REAL ( KIND = 4 ) F
! !      REAL ( KIND = 4 ) X
! !    WHICH EVALUATES THE INTEGRAND FUNCTION.
! !
! !    INPUT, REAL ( KIND = 4 ) A, B, THE LIMITS OF INTEGRATION.
! !
! !    INPUT, REAL ( KIND = 4 ) EPSABS, EPSREL, THE ABSOLUTE AND RELATIVE ACCURACY REQUESTED.
! !
! !    OUTPUT, REAL ( KIND = 4 ) RESULT, THE ESTIMATED VALUE OF THE INTEGRAL.
! !    RESULT IS OBTAINED BY APPLYING THE 21-POINT GAUSS-KRONROD RULE (RES21)
! !    OBTAINED  BY OPTIMAL ADDITION OF ABSCISSAE TO THE 10-POINT GAUSS RULE
! !    (RES10), OR BY APPLYING THE 43-POINT RULE (RES43) OBTAINED BY OPTIMAL
! !    ADDITION OF ABSCISSAE TO THE 21-POINT GAUSS-KRONROD RULE, OR BY
! !    APPLYING THE 87-POINT RULE (RES87) OBTAINED BY OPTIMAL ADDITION OF
! !    ABSCISSAE TO THE 43-POINT RULE.
! !
! !    OUTPUT, REAL ( KIND = 4 ) ABSERR, AN ESTIMATE OF || I - RESULT ||.
! !
! !    OUTPUT, INTEGER ( KIND = 4 ) NEVAL, THE NUMBER OF TIMES THE INTEGRAL WAS EVALUATED.
! !
! !           IER    - IER = 0 NORMAL AND RELIABLE TERMINATION OF THE
! !                            ROUTINE. IT IS ASSUMED THAT THE REQUESTED
! !                            ACCURACY HAS BEEN ACHIEVED.
! !                    IER > 0 ABNORMAL TERMINATION OF THE ROUTINE. IT IS
! !                            ASSUMED THAT THE REQUESTED ACCURACY HAS
! !                            NOT BEEN ACHIEVED.
! !                    IER = 1 THE MAXIMUM NUMBER OF STEPS HAS BEEN
! !                            EXECUTED. THE INTEGRAL IS PROBABLY TOO
! !                            DIFFICULT TO BE CALCULATED BY QNG.
! !                        = 6 THE INPUT IS INVALID, BECAUSE
! !                            EPSABS < 0 AND EPSREL < 0,
! !                            RESULT, ABSERR AND NEVAL ARE SET TO ZERO.
! !
! !  LOCAL PARAMETERS:
! !
! !           CENTR  - MID POINT OF THE INTEGRATION INTERVAL
! !           HLGTH  - HALF-LENGTH OF THE INTEGRATION INTERVAL
! !           FCENTR - FUNCTION VALUE AT MID POINT
! !           ABSC   - ABSCISSA
! !           FVAL   - FUNCTION VALUE
! !           SAVFUN - ARRAY OF FUNCTION VALUES WHICH HAVE ALREADY
! !                    BEEN COMPUTED
! !           RES10  - 10-POINT GAUSS RESULT
! !           RES21  - 21-POINT KRONROD RESULT
! !           RES43  - 43-POINT RESULT
! !           RES87  - 87-POINT RESULT
! !           RESABS - APPROXIMATION TO THE INTEGRAL OF ABS(F)
! !           RESASC - APPROXIMATION TO THE INTEGRAL OF ABS(F-I/(B-A))
! !
!   IMPLICIT NONE
!
!   REAL ( KIND = 4 ) A
!   REAL ( KIND = 4 ) ABSC
!   REAL ( KIND = 4 ) ABSERR
!   REAL ( KIND = 4 ) B
!   REAL ( KIND = 4 ) CENTR
!   REAL ( KIND = 4 ) DHLGTH
!   REAL ( KIND = 4 ) EPSABS
!   REAL ( KIND = 4 ) EPSREL
!   REAL ( KIND = 4 ), EXTERNAL :: F
!   REAL ( KIND = 4 ) FCENTR
!   REAL ( KIND = 4 ) FVAL
!   REAL ( KIND = 4 ) FVAL1
!   REAL ( KIND = 4 ) FVAL2
!   REAL ( KIND = 4 ) FV1(5)
!   REAL ( KIND = 4 ) FV2(5)
!   REAL ( KIND = 4 ) FV3(5)
!   REAL ( KIND = 4 ) FV4(5)
!   REAL ( KIND = 4 ) HLGTH
!   INTEGER ( KIND = 4 ) IER
!   INTEGER ( KIND = 4 ) IPX
!   INTEGER ( KIND = 4 ) K
!   INTEGER ( KIND = 4 ) L
!   INTEGER ( KIND = 4 ) NEVAL
!   REAL ( KIND = 4 ) RESULT
!   REAL ( KIND = 4 ) RES10
!   REAL ( KIND = 4 ) RES21
!   REAL ( KIND = 4 ) RES43
!   REAL ( KIND = 4 ) RES87
!   REAL ( KIND = 4 ) RESABS
!   REAL ( KIND = 4 ) RESASC
!   REAL ( KIND = 4 ) RESKH
!   REAL ( KIND = 4 ) SAVFUN(21)
!   REAL ( KIND = 4 ) W10(5)
!   REAL ( KIND = 4 ) W21A(5)
!   REAL ( KIND = 4 ) W21B(6)
!   REAL ( KIND = 4 ) W43A(10)
!   REAL ( KIND = 4 ) W43B(12)
!   REAL ( KIND = 4 ) W87A(21)
!   REAL ( KIND = 4 ) W87B(23)
!   REAL ( KIND = 4 ) X1(5)
!   REAL ( KIND = 4 ) X2(5)
!   REAL ( KIND = 4 ) X3(11)
!   REAL ( KIND = 4 ) X4(22)
! !
! !           THE FOLLOWING DATA STATEMENTS CONTAIN THE ABSCISSAE
! !           AND WEIGHTS OF THE INTEGRATION RULES USED.
! !
! !           X1      ABSCISSAE COMMON TO THE 10-, 21-, 43- AND 87-POINT
! !                   RULE
! !           X2      ABSCISSAE COMMON TO THE 21-, 43- AND 87-POINT RULE
! !           X3      ABSCISSAE COMMON TO THE 43- AND 87-POINT RULE
! !           X4      ABSCISSAE OF THE 87-POINT RULE
! !           W10     WEIGHTS OF THE 10-POINT FORMULA
! !           W21A    WEIGHTS OF THE 21-POINT FORMULA FOR ABSCISSAE X1
! !           W21B    WEIGHTS OF THE 21-POINT FORMULA FOR ABSCISSAE X2
! !           W43A    WEIGHTS OF THE 43-POINT FORMULA FOR ABSISSAE X1, X3
! !           W43B    WEIGHTS OF THE 43-POINT FORMULA FOR ABSCISSAE X3
! !           W87A    WEIGHTS OF THE 87-POINT FORMULA FOR ABSCISSAE X1,
! !                   X2 AND X3
! !           W87B    WEIGHTS OF THE 87-POINT FORMULA FOR ABSCISSAE X4
! !
!   DATA X1(1),X1(2),X1(3),X1(4),X1(5)/ &
!        9.739065285171717E-01,     8.650633666889845E-01, &
!        6.794095682990244E-01,     4.333953941292472E-01, &
!        1.488743389816312E-01/
!   DATA X2(1),X2(2),X2(3),X2(4),X2(5)/ &
!        9.956571630258081E-01,     9.301574913557082E-01, &
!        7.808177265864169E-01,     5.627571346686047E-01, &
!        2.943928627014602E-01/
!   DATA X3(1),X3(2),X3(3),X3(4),X3(5),X3(6),X3(7),X3(8),X3(9),X3(10), &
!     X3(11)/ &
!        9.993333609019321E-01,     9.874334029080889E-01, &
!        9.548079348142663E-01,     9.001486957483283E-01, &
!        8.251983149831142E-01,     7.321483889893050E-01, &
!        6.228479705377252E-01,     4.994795740710565E-01, &
!        3.649016613465808E-01,     2.222549197766013E-01, &
!        7.465061746138332E-02/
!   DATA X4(1),X4(2),X4(3),X4(4),X4(5),X4(6),X4(7),X4(8),X4(9),X4(10), &
!     X4(11),X4(12),X4(13),X4(14),X4(15),X4(16),X4(17),X4(18),X4(19), &
!     X4(20),X4(21),X4(22)/         9.999029772627292E-01, &
!        9.979898959866787E-01,     9.921754978606872E-01, &
!        9.813581635727128E-01,     9.650576238583846E-01, &
!        9.431676131336706E-01,     9.158064146855072E-01, &
!        8.832216577713165E-01,     8.457107484624157E-01, &
!        8.035576580352310E-01,     7.570057306854956E-01, &
!        7.062732097873218E-01,     6.515894665011779E-01, &
!        5.932233740579611E-01,     5.314936059708319E-01, &
!        4.667636230420228E-01,     3.994248478592188E-01, &
!        3.298748771061883E-01,     2.585035592021616E-01, &
!        1.856953965683467E-01,     1.118422131799075E-01, &
!        3.735212339461987E-02/
!   DATA W10(1),W10(2),W10(3),W10(4),W10(5)/ &
!        6.667134430868814E-02,     1.494513491505806E-01, &
!        2.190863625159820E-01,     2.692667193099964E-01, &
!        2.955242247147529E-01/
!   DATA W21A(1),W21A(2),W21A(3),W21A(4),W21A(5)/ &
!        3.255816230796473E-02,     7.503967481091995E-02, &
!        1.093871588022976E-01,     1.347092173114733E-01, &
!        1.477391049013385E-01/
!   DATA W21B(1),W21B(2),W21B(3),W21B(4),W21B(5),W21B(6)/ &
!        1.169463886737187E-02,     5.475589657435200E-02, &
!        9.312545458369761E-02,     1.234919762620659E-01, &
!        1.427759385770601E-01,     1.494455540029169E-01/
!   DATA W43A(1),W43A(2),W43A(3),W43A(4),W43A(5),W43A(6),W43A(7), &
!     W43A(8),W43A(9),W43A(10)/     1.629673428966656E-02, &
!        3.752287612086950E-02,     5.469490205825544E-02, &
!        6.735541460947809E-02,     7.387019963239395E-02, &
!        5.768556059769796E-03,     2.737189059324884E-02, &
!        4.656082691042883E-02,     6.174499520144256E-02, &
!        7.138726726869340E-02/
!   DATA W43B(1),W43B(2),W43B(3),W43B(4),W43B(5),W43B(6),W43B(7), &
!     W43B(8),W43B(9),W43B(10),W43B(11),W43B(12)/ &
!        1.844477640212414E-03,     1.079868958589165E-02, &
!        2.189536386779543E-02,     3.259746397534569E-02, &
!        4.216313793519181E-02,     5.074193960018458E-02, &
!        5.837939554261925E-02,     6.474640495144589E-02, &
!        6.956619791235648E-02,     7.282444147183321E-02, &
!        7.450775101417512E-02,     7.472214751740301E-02/
!   DATA W87A(1),W87A(2),W87A(3),W87A(4),W87A(5),W87A(6),W87A(7), &
!     W87A(8),W87A(9),W87A(10),W87A(11),W87A(12),W87A(13),W87A(14), &
!     W87A(15),W87A(16),W87A(17),W87A(18),W87A(19),W87A(20),W87A(21)/ &
!        8.148377384149173E-03,     1.876143820156282E-02, &
!        2.734745105005229E-02,     3.367770731163793E-02, &
!        3.693509982042791E-02,     2.884872430211531E-03, &
!        1.368594602271270E-02,     2.328041350288831E-02, &
!        3.087249761171336E-02,     3.569363363941877E-02, &
!        9.152833452022414E-04,     5.399280219300471E-03, &
!        1.094767960111893E-02,     1.629873169678734E-02, &
!        2.108156888920384E-02,     2.537096976925383E-02, &
!        2.918969775647575E-02,     3.237320246720279E-02, &
!        3.478309895036514E-02,     3.641222073135179E-02, &
!        3.725387550304771E-02/
!   DATA W87B(1),W87B(2),W87B(3),W87B(4),W87B(5),W87B(6),W87B(7), &
!     W87B(8),W87B(9),W87B(10),W87B(11),W87B(12),W87B(13),W87B(14), &
!     W87B(15),W87B(16),W87B(17),W87B(18),W87B(19),W87B(20),W87B(21), &
!     W87B(22),W87B(23)/            2.741455637620724E-04, &
!        1.807124155057943E-03,     4.096869282759165E-03, &
!        6.758290051847379E-03,     9.549957672201647E-03, &
!        1.232944765224485E-02,     1.501044734638895E-02, &
!        1.754896798624319E-02,     1.993803778644089E-02, &
!        2.219493596101229E-02,     2.433914712600081E-02, &
!        2.637450541483921E-02,     2.828691078877120E-02, &
!        3.005258112809270E-02,     3.164675137143993E-02, &
!        3.305041341997850E-02,     3.425509970422606E-02, &
!        3.526241266015668E-02,     3.607698962288870E-02, &
!        3.669860449845609E-02,     3.712054926983258E-02, &
!        3.733422875193504E-02,     3.736107376267902E-02/
! !
! !  TEST ON VALIDITY OF PARAMETERS.
! !
!   RESULT = 0.0E+00
!   ABSERR = 0.0E+00
!   NEVAL = 0
!
!   IF ( EPSABS < 0.0E+00 .AND. EPSREL < 0.0E+00 ) THEN
!     IER = 6
!     RETURN
!   END IF
!
!   HLGTH = 5.0E-01 * ( B - A )
!   DHLGTH = ABS ( HLGTH )
!   CENTR = 5.0E-01 * ( B + A )
!   FCENTR = F(CENTR)
!   NEVAL = 21
!   IER = 1
! !
! !  COMPUTE THE INTEGRAL USING THE 10- AND 21-POINT FORMULA.
! !
!   DO L = 1, 3
!
!     IF ( L == 1 ) THEN
!
!       RES10 = 0.0E+00
!       RES21 = W21B(6) * FCENTR
!       RESABS = W21B(6) * ABS(FCENTR)
!
!       DO K = 1, 5
!         ABSC = HLGTH * X1(K)
!         FVAL1 = F(CENTR+ABSC)
!         FVAL2 = F(CENTR-ABSC)
!         FVAL = FVAL1 + FVAL2
!         RES10 = RES10 + W10(K)*FVAL
!         RES21 = RES21 + W21A(K)*FVAL
!         RESABS = RESABS + W21A(K)*(ABS(FVAL1)+ABS(FVAL2))
!         SAVFUN(K) = FVAL
!         FV1(K) = FVAL1
!         FV2(K) = FVAL2
!       END DO
!
!       IPX = 5
!
!       DO K = 1, 5
!         IPX = IPX + 1
!         ABSC = HLGTH * X2(K)
!         FVAL1 = F(CENTR+ABSC)
!         FVAL2 = F(CENTR-ABSC)
!         FVAL = FVAL1 + FVAL2
!         RES21 = RES21 + W21B(K) * FVAL
!         RESABS = RESABS + W21B(K) * ( ABS ( FVAL1 ) + ABS ( FVAL2 ) )
!         SAVFUN(IPX) = FVAL
!         FV3(K) = FVAL1
!         FV4(K) = FVAL2
!       END DO
! !
! !  TEST FOR CONVERGENCE.
! !
!       RESULT = RES21 * HLGTH
!       RESABS = RESABS * DHLGTH
!       RESKH = 5.0E-01 * RES21
!       RESASC = W21B(6) * ABS ( FCENTR - RESKH )
!
!       DO K = 1, 5
!         RESASC = RESASC+W21A(K)*(ABS(FV1(K)-RESKH)+ABS(FV2(K)-RESKH)) &
!                      +W21B(K)*(ABS(FV3(K)-RESKH)+ABS(FV4(K)-RESKH))
!       END DO
!
!       ABSERR = ABS ( ( RES21 - RES10 ) * HLGTH )
!       RESASC = RESASC * DHLGTH
! !
! !  COMPUTE THE INTEGRAL USING THE 43-POINT FORMULA.
! !
!     ELSE IF ( L == 2 ) THEN
!
!       RES43 = W43B(12)*FCENTR
!       NEVAL = 43
!
!       DO K = 1, 10
!         RES43 = RES43 + SAVFUN(K) * W43A(K)
!       END DO
!
!       DO K = 1, 11
!         IPX = IPX + 1
!         ABSC = HLGTH * X3(K)
!         FVAL = F(ABSC+CENTR) + F(CENTR-ABSC)
!         RES43 = RES43 + FVAL * W43B(K)
!         SAVFUN(IPX) = FVAL
!       END DO
! !
! !  TEST FOR CONVERGENCE.
! !
!       RESULT = RES43 * HLGTH
!       ABSERR = ABS((RES43-RES21)*HLGTH)
! !
! !  COMPUTE THE INTEGRAL USING THE 87-POINT FORMULA.
! !
!     ELSE IF ( L == 3 ) THEN
!
!       RES87 = W87B(23) * FCENTR
!       NEVAL = 87
!
!       DO K = 1, 21
!         RES87 = RES87 + SAVFUN(K) * W87A(K)
!       END DO
!
!       DO K = 1, 22
!         ABSC = HLGTH * X4(K)
!         RES87 = RES87 + W87B(K) * ( F(ABSC+CENTR) + F(CENTR-ABSC) )
!       END DO
!
!       RESULT = RES87 * HLGTH
!       ABSERR = ABS ( ( RES87 - RES43) * HLGTH )
!
!     END IF
!
!     IF ( RESASC /= 0.0E+00.AND.ABSERR /= 0.0E+00 ) THEN
!       ABSERR = RESASC * MIN ( 1.0E+00,(2.0E+02*ABSERR/RESASC)**1.5E+00)
!     END IF
!
!     IF ( RESABS > TINY ( RESABS ) / ( 5.0E+01 * EPSILON ( RESABS ) ) ) THEN
!       ABSERR = MAX (( EPSILON ( RESABS ) *5.0E+01) * RESABS, ABSERR )
!     END IF
!
!     IF ( ABSERR <= MAX ( EPSABS, EPSREL*ABS(RESULT))) THEN
!       IER = 0
!     END IF
!
!     IF ( IER == 0 ) THEN
!       EXIT
!     END IF
!
!   END DO
!
!   RETURN
! END

#endif
